document.addEventListener('DOMContentLoaded', () => {
    const folderPathInput = document.getElementById('folderPath');
    const scanBtn = document.getElementById('scanBtn');
    const browseBtn = document.getElementById('browseBtn');
    const themeToggle = document.getElementById('themeToggle');
    const fileList = document.getElementById('fileList');
    const dataContainer = document.getElementById('dataContainer');
    const fileNameDisplay = document.getElementById('fileName');
    const tableListDisplay = document.getElementById('tableList');
    const statusDisplay = document.getElementById('status');
    const saveBtn = document.getElementById('saveBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisModal = document.getElementById('analysisModal');
    const closeModal = document.querySelector('.close-modal');
    const analysisResult = document.getElementById('analysisResult');
    const tabGeological = document.getElementById('tabGeological');
    const tabRawFiles = document.getElementById('tabRawFiles');

    let currentFile = null;
    let currentTable = null;
    let pendingChanges = {}; // Map of rowId -> { col: newVal }
    let currentTab = 'geological'; // 'geological' or 'raw'
    let rawFilesCache = [];
    let geologicalDataCache = {};

    // Theme Management
    const savedTheme = localStorage.getItem('dgss_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('dgss_theme', newTheme);
    });

    // Load last used path from localStorage
    const savedPath = localStorage.getItem('dgss_last_path');
    if (savedPath) {
        folderPathInput.value = savedPath;
    }

    browseBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/select-folder', { method: 'POST' });
            const data = await response.json();
            if (data.path) {
                folderPathInput.value = data.path;
                scanFolder();
            }
        } catch (error) {
            console.error('Error opening dialog:', error);
        }
    });

    scanBtn.addEventListener('click', scanFolder);
    folderPathInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') scanFolder();
    });

    saveBtn.addEventListener('click', async () => {
        if (!currentFile || !currentTable || Object.keys(pendingChanges).length === 0) return;

        statusDisplay.textContent = '保存中...';
        let successCount = 0;
        let errorCount = 0;

        for (const [rowId, updates] of Object.entries(pendingChanges)) {
            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: currentFile.path,
                        tableName: currentTable,
                        id: rowId,
                        updates: updates
                    })
                });

                if (response.ok) {
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (error) {
                console.error('Error saving row:', rowId, error);
                errorCount++;
            }
        }

        if (errorCount === 0) {
            statusDisplay.textContent = '所有更改已保存';
            pendingChanges = {};
            saveBtn.classList.remove('visible');
            // Refresh data
            loadFileData(currentFile, null, currentTable);
        } else {
            statusDisplay.textContent = `已保存 ${successCount} 项,失败 ${errorCount} 项`;
        }
    });

    // Tab Management
    function switchTab(tab) {
        currentTab = tab;

        // Update UI
        if (tab === 'geological') {
            tabGeological.classList.add('active');
            tabRawFiles.classList.remove('active');
            if (Object.keys(geologicalDataCache).length > 0) {
                renderGeologicalList(geologicalDataCache);
            } else {
                scanFolder();
            }
        } else {
            tabGeological.classList.remove('active');
            tabRawFiles.classList.add('active');
            if (rawFilesCache.length > 0) {
                renderRawFileList(rawFilesCache);
            } else {
                scanFolder();
            }
        }
    }

    tabGeological.addEventListener('click', () => switchTab('geological'));
    tabRawFiles.addEventListener('click', () => switchTab('raw'));

    // Horizontal Scroll with Wheel
    dataContainer.addEventListener('wheel', (e) => {
        if (e.deltaY !== 0 && !e.shiftKey) {
            // Check if content overflows horizontally
            if (dataContainer.scrollWidth > dataContainer.clientWidth) {
                e.preventDefault();
                dataContainer.scrollLeft += e.deltaY;
            }
        }
    });

    async function scanFolder() {
        const path = folderPathInput.value.trim();
        if (!path) return;

        localStorage.setItem('dgss_last_path', path);
        statusDisplay.textContent = '扫描中...';
        fileList.innerHTML = '<div class="empty-state">扫描中...</div>';

        try {
            if (currentTab === 'geological') {
                // Use geological scanning API
                const response = await fetch('/api/scan-geological', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const data = await response.json();

                if (response.ok) {
                    geologicalDataCache = data;
                    renderGeologicalList(data);
                    // Count total items
                    let totalItems = 0;
                    Object.values(data).forEach(category => {
                        if (category.items) totalItems += category.items.length;
                    });
                    statusDisplay.textContent = `找到 ${totalItems} 个地质数据项`;
                } else {
                    alert(data.error);
                    statusDisplay.textContent = '错误';
                }
            } else {
                // Use raw file scanning API
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const data = await response.json();

                if (response.ok) {
                    rawFilesCache = data.files;
                    renderRawFileList(data.files);
                    statusDisplay.textContent = `找到 ${data.files.length} 个文件`;
                } else {
                    alert(data.error);
                    statusDisplay.textContent = '错误';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            statusDisplay.textContent = '扫描文件夹时出错';
        }
    }

    function renderRawFileList(files) {
        fileList.innerHTML = '';

        if (!files || files.length === 0) {
            fileList.innerHTML = '<div class="empty-state">未找到支持的文件</div>';
            return;
        }

        // Group by extension for better organization
        const groups = {};
        files.forEach(file => {
            const ext = file.name.split('.').pop().toUpperCase();
            if (!groups[ext]) groups[ext] = [];
            groups[ext].push(file);
        });

        Object.keys(groups).sort().forEach(ext => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'file-category';

            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `<span>${ext} 文件</span> <span>${groups[ext].length}</span>`;
            categoryDiv.appendChild(header);

            groups[ext].forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-path" style="font-size: 0.7rem; color: var(--text-secondary);">${file.path}</div>
                `;

                item.addEventListener('click', () => {
                    document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadFileData(file);
                });

                categoryDiv.appendChild(item);
            });

            fileList.appendChild(categoryDiv);
        });
    }

    // Analysis Tools
    analyzeBtn.addEventListener('click', async () => {
        const path = folderPathInput.value.trim();
        if (!path) {
            alert('请先选择一个文件夹');
            return;
        }

        analysisModal.style.display = 'block';
        analysisResult.innerHTML = '<div class="loading-spinner">正在分析结构... 这可能需要一些时间。</div>';

        try {
            const response = await fetch('/api/analyze-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            });

            const data = await response.json();

            if (response.ok) {
                renderAnalysisResult(data);
            } else {
                analysisResult.innerHTML = `<div style="color: var(--error-color)">错误: ${data.error}</div>`;
            }
        } catch (error) {
            analysisResult.innerHTML = `<div style="color: var(--error-color)">连接错误: ${error.message}</div>`;
        }

        // Analysis Tools
        analyzeBtn.addEventListener('click', async () => {
            const path = folderPathInput.value.trim();
            if (!path) {
                alert('Please select a folder first');
                return;
            }

            analysisModal.style.display = 'block';
            analysisResult.innerHTML = '<div class="loading-spinner">Analyzing structure... This may take a moment.</div>';

            try {
                const response = await fetch('/api/analyze-structure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const data = await response.json();

                if (response.ok) {
                    renderAnalysisResult(data);
                } else {
                    analysisResult.innerHTML = `<div style="color: var(--error-color)">Error: ${data.error}</div>`;
                }
            } catch (error) {
                analysisResult.innerHTML = `<div style="color: var(--error-color)">Connection Error: ${error.message}</div>`;
            }
        });

        closeModal.addEventListener('click', () => {
            analysisModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === analysisModal) {
                let hasData = false;

                Object.entries(data).forEach(([category, config]) => {
                    if (config.items && config.items.length > 0) {
                        hasData = true;

                        // Create category group
                        const group = document.createElement('div');
                        group.className = 'category-group';

                        // Category title (collapsible)
                        const title = document.createElement('div');
                        title.className = 'category-title';
                        title.innerHTML = `
                    <span class="category-icon">${config.icon}</span>
                    <span class="category-name">${category}</span>
                    <span class="category-count">(${config.items.length})</span>
                `;
                        title.onclick = () => {
                            group.classList.toggle('collapsed');
                        };
                        group.appendChild(title);

                        // Category items container
                        const itemsContainer = document.createElement('div');
                        itemsContainer.className = 'category-items';

                        config.items.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'file-item';
                            itemEl.innerHTML = `
                        <div class="file-item-main">
                            <span class="file-name">${item.fileName}</span>
                            <span class="table-badge">${item.tableName}</span>
                        </div>
                        ${item.description ? `<div class="file-description">${item.description}</div>` : ''}
                    `;
                            itemEl.onclick = function () {
                                // Remove active class from all items
                                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                                itemEl.classList.add('active');
                                loadGeologicalData(item);
                            };
                            itemsContainer.appendChild(itemEl);
                        });

                        group.appendChild(itemsContainer);
                        fileList.appendChild(group);
                    }
                });

                if (!hasData) {
                    fileList.innerHTML = '<div class="no-data">未找到地质数据</div>';
                }
            }

            // Load geological data
            async function loadGeologicalData(item) {
                currentFile = {
                    path: item.filePath,
                    name: `${item.fileName} > ${item.tableName}`
                };
                pendingChanges = {};
                saveBtn.classList.remove('visible');

                fileNameDisplay.textContent = item.description || `${item.fileName} > ${item.tableName}`;
                tableListDisplay.innerHTML = '';

                statusDisplay.textContent = 'Loading data...';
                dataContainer.innerHTML = '<div class="placeholder-content"><p>Loading...</p></div>';

                try {
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: item.filePath,
                            tableName: item.tableName
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        currentTable = data.tableName;
                        renderTable(data);
                        // Show available tables in this file
                        if (data.allTables) {
                            renderTableList(data.allTables, data.tableName, currentFile, null);
                        }
                        statusDisplay.textContent = 'Ready';
                    } else {
                        dataContainer.innerHTML = `<div class="placeholder-content" style="color: var(--error-color)"><p>${data.error}</p></div>`;
                        statusDisplay.textContent = 'Error loading file';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    dataContainer.innerHTML = '<div class="placeholder-content"><p>Error connecting to server</p></div>';
                }
            }

            // Keep old function for backward compatibility
            function renderFileList(files) {
                fileList.innerHTML = '';

                const categories = {
                    'Points': [],
                    'Lines': [],
                    'Polygons': [],
                    'Notes': [],
                    'Other': []
                };

                files.forEach(file => {
                    if (categories[file.category]) {
                        categories[file.category].push(file);
                    } else {
                        categories['Other'].push(file);
                    }
                });

                Object.entries(categories).forEach(([category, items]) => {
                    if (items.length > 0) {
                        const group = document.createElement('div');
                        group.className = 'category-group';

                        const title = document.createElement('div');
                        title.className = 'category-title';
                        title.textContent = category;
                        group.appendChild(title);

                        items.forEach(file => {
                            const item = document.createElement('div');
                            item.className = 'file-item';
                            item.textContent = file.name;
                            item.onclick = () => loadFileData(file, item);
                            group.appendChild(item);
                        });

                        fileList.appendChild(group);
                    }
                });
            }

            async function loadFileData(file, element, tableName = null) {
                currentFile = file;
                pendingChanges = {}; // Reset changes on file load
                saveBtn.classList.remove('visible');

                // Update UI selection
                if (element) {
                    document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                    element.classList.add('active');
                }

                fileNameDisplay.textContent = file.name;
                if (!tableName) {
                    tableListDisplay.innerHTML = ''; // Clear tables if loading new file
                }

                statusDisplay.textContent = 'Loading data...';
                dataContainer.innerHTML = '<div class="placeholder-content"><p>Loading...</p></div>';

                try {
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: file.path,
                            tableName: tableName
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        currentTable = data.tableName; // Store current table
                        renderTable(data);
                        renderTableList(data.allTables, data.tableName, file, element);
                        statusDisplay.textContent = 'Ready';
                    } else {
                        dataContainer.innerHTML = `<div class="placeholder-content" style="color: var(--error-color)"><p>${data.error}</p></div>`;
                        statusDisplay.textContent = 'Error loading file';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    dataContainer.innerHTML = '<div class="placeholder-content"><p>Error connecting to server</p></div>';
                }
            }

            function renderTableList(tables, currentTable, file, element) {
                tableListDisplay.innerHTML = '';
                if (!tables) return;

                tables.forEach(table => {
                    const chip = document.createElement('div');
                    chip.className = `table-chip ${table === currentTable ? 'active' : ''}`;
                    chip.textContent = table;
                    chip.onclick = () => loadFileData(file, element, table);
                    tableListDisplay.appendChild(chip);
                });
            }

            function renderTable(data) {
                if (!data.rows || data.rows.length === 0) {
                    dataContainer.innerHTML = '<div class="placeholder-content"><p>此表中没有数据</p></div>';
                    return;
                }

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                // Header
                const headerRow = document.createElement('tr');
                data.columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Body
                data.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    const rowId = row['_id']; // Assuming _id exists

                    data.columns.forEach(col => {
                        const td = document.createElement('td');
                        td.textContent = row[col];

                        // Make editable if it's not the ID column
                        if (col !== '_id') {
                            td.contentEditable = true;
                            td.addEventListener('input', () => {
                                if (!pendingChanges[rowId]) pendingChanges[rowId] = {};
                                pendingChanges[rowId][col] = td.textContent;
                                td.classList.add('modified');
                                saveBtn.classList.add('visible');
                                statusDisplay.textContent = '有未保存的更改...';
                            });
                        }

                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                table.appendChild(thead);
                table.appendChild(tbody);

                dataContainer.innerHTML = '';
                dataContainer.appendChild(table);
            }
        });
